pipeline {
    agent any

    tools {
        maven 'Maven 3.8.1' // El nombre debe coincidir con la configuración en Jenkins
    }

    environment {
        SONAR_TOKEN = credentials('sonarcloud-token')
        SONAR_ORG = 'your-organization-key'
        SONAR_PROJECT = 'your-project-key'
    }

    stages {
        stage('SonarCloud Analysis') {
            steps {
                sh '''
                #!/bin/bash
                if [ -z "$SONAR_ORG" ] || [ -z "$SONAR_PROJECT" ] || [ -z "$SONAR_TOKEN" ]; then
                  echo "Error: Las variables de entorno SONAR_ORG, SONAR_PROJECT o SONAR_TOKEN no están definidas."
                  exit 1
                fi

                mvn sonar:sonar \
                  -Dsonar.organization="$SONAR_ORG" \
                  -Dsonar.projectKey="$SONAR_PROJECT" \
                  -Dsonar.login="$SONAR_TOKEN"
                '''
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
